---
phase: 03-todo-priority-system
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/keybindings/mod.rs
  - src/app/state.rs
autonomous: true

must_haves:
  truths:
    - "User can press 'p' to cycle priority on selected todo"
    - "Plugin menu moved from 'p' to 'P' (capital P)"
    - "Priority cycles: None -> P0 -> P1 -> P2 -> None"
    - "Status bar shows confirmation after priority change"
  artifacts:
    - path: "src/keybindings/mod.rs"
      provides: "CyclePriority action and keybindings"
      contains: "CyclePriority"
    - path: "src/app/state.rs"
      provides: "cycle_priority method on AppState"
      contains: "cycle_priority"
  key_links:
    - from: "src/keybindings/mod.rs"
      to: "src/app/state.rs"
      via: "Action::CyclePriority triggers state.cycle_priority()"
      pattern: "CyclePriority"
---

<objective>
Implement 'p' key to cycle priority on the current todo.

Purpose: Enable quick priority assignment via keyboard.
Output: Keybinding change (p -> cycle priority, P -> plugin menu), state mutation method.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan for context on what was built
@.planning/phases/03-todo-priority-system/03-01-SUMMARY.md

@src/keybindings/mod.rs
@src/app/state.rs
@src/app/event.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CyclePriority action and remap keybindings</name>
  <files>src/keybindings/mod.rs</files>
  <action>
1. Add `CyclePriority` variant to the Action enum (after Yank is fine)

2. Add Display impl case: `Action::CyclePriority => "cycle_priority"`

3. Add FromStr impl case: `"cycle_priority" => Ok(Action::CyclePriority)`

4. In default_navigate_bindings():
   - Change `m.insert("p".to_string(), "open_plugin_menu".to_string())` to:
     `m.insert("p".to_string(), "cycle_priority".to_string())`
   - Add: `m.insert("P".to_string(), "open_plugin_menu".to_string())`

This moves plugin menu from 'p' to 'P' (capital P) and assigns 'p' to cycle priority.
  </action>
  <verify>cargo build --lib passes</verify>
  <done>CyclePriority action exists, p -> cycle_priority, P -> plugin menu</done>
</task>

<task type="auto">
  <name>Task 2: Implement cycle_priority in AppState</name>
  <files>src/app/state.rs</files>
  <action>
Add method to AppState:

```rust
pub fn cycle_priority(&mut self) {
    if self.is_readonly() {
        return;
    }

    if let Some(item) = self.todo_list.items.get_mut(self.cursor_position) {
        self.save_undo_state();
        item.priority = item.priority.map_or(Some(Priority::P0), |p| p.next());
        item.modified_at = chrono::Utc::now();

        let priority_str = item.priority
            .map(|p| p.to_string())
            .unwrap_or_else(|| "None".to_string());
        self.status_message = Some(format!("Priority: {}", priority_str));
    }
}
```

Make sure to import Priority from crate::todo::Priority at the top of the file.

The method should:
- Check readonly mode (archived dates can't be edited)
- Save undo state before modification
- Cycle priority using the next() method from Priority enum
- Update modified_at timestamp
- Set status message showing new priority
  </action>
  <verify>cargo build passes</verify>
  <done>cycle_priority method exists and mutates todo priority</done>
</task>

<task type="auto">
  <name>Task 3: Wire CyclePriority action to event handler</name>
  <files>src/app/event.rs</files>
  <action>
In the Navigate mode match arm for keybinding actions, add case:

```rust
Action::CyclePriority => {
    state.cycle_priority();
}
```

Add this alongside the other item manipulation actions (near ToggleState, CycleState, etc.).
  </action>
  <verify>cargo build passes; cargo test passes</verify>
  <done>Pressing 'p' in Navigate mode cycles priority</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo build` succeeds without errors
- [ ] `cargo test` passes all tests
- [ ] `cargo clippy` has no warnings
- [ ] Pressing 'p' cycles priority (None -> P0 -> P1 -> P2 -> None)
- [ ] Pressing 'P' opens plugin menu
- [ ] Status bar shows "Priority: P0" etc. after cycling
- [ ] Undo works after priority change
</verification>

<success_criteria>

- All tasks completed
- 'p' key cycles priority
- 'P' key opens plugin menu (moved from 'p')
- Status message confirms priority change
- Undo functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/03-todo-priority-system/03-02-SUMMARY.md`
</output>
