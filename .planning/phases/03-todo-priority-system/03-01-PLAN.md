---
phase: 03-todo-priority-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/todo/mod.rs
  - src/todo/priority.rs
  - src/todo/item.rs
  - src/storage/database.rs
  - src/storage/markdown.rs
autonomous: true

must_haves:
  truths:
    - "TodoItem has priority field that persists across saves"
    - "Priority values can be None, P0, P1, or P2"
    - "Priority serializes to/from database correctly"
    - "Priority serializes to/from markdown correctly"
  artifacts:
    - path: "src/todo/priority.rs"
      provides: "Priority enum definition"
      exports: ["Priority"]
    - path: "src/todo/item.rs"
      provides: "TodoItem with priority field"
      contains: "priority: Option<Priority>"
    - path: "src/storage/database.rs"
      provides: "Database schema with priority column"
      contains: "priority TEXT"
  key_links:
    - from: "src/todo/item.rs"
      to: "src/todo/priority.rs"
      via: "use super::priority::Priority"
      pattern: "use.*Priority"
    - from: "src/storage/database.rs"
      to: "src/todo/priority.rs"
      via: "Priority::from_str and to_string"
      pattern: "priority"
---

<objective>
Add priority data model to TodoItem with database and markdown persistence.

Purpose: Enable todos to have priority levels (P0/P1/P2) that persist across sessions.
Output: Priority enum, updated TodoItem, database schema migration, markdown serialization.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/todo/mod.rs
@src/todo/item.rs
@src/todo/state.rs
@src/storage/database.rs
@src/storage/markdown.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Priority enum module</name>
  <files>src/todo/priority.rs, src/todo/mod.rs</files>
  <action>
Create new file src/todo/priority.rs with Priority enum:
- Variants: None (no priority), P0 (critical), P1 (high), P2 (medium)
- Implement Display trait (P0 -> "P0", P1 -> "P1", P2 -> "P2", None -> "")
- Implement FromStr trait for parsing from database/markdown
- Implement Default trait (returns None)
- Implement Copy, Clone, Debug, PartialEq, Eq, Serialize, Deserialize
- Add method `next()` to cycle: None -> P0 -> P1 -> P2 -> None
- Add method `to_db_str()` returning Option<String> for database storage
- Add method `from_db_str(s: Option<&str>)` for database loading

Export from src/todo/mod.rs alongside TodoState.
  </action>
  <verify>cargo build --lib passes</verify>
  <done>Priority enum exists with cycling and serialization methods</done>
</task>

<task type="auto">
  <name>Task 2: Add priority field to TodoItem</name>
  <files>src/todo/item.rs</files>
  <action>
Add `priority: Option<Priority>` field to TodoItem struct.
- Import Priority from super::priority
- Add field after existing fields (before created_at is fine)
- Initialize to None in TodoItem::new()
- Initialize from parameter in TodoItem::full() - add priority parameter
- Update any builder methods if they exist

Do NOT add display logic yet - that's Plan 03-03.
  </action>
  <verify>cargo build --lib passes</verify>
  <done>TodoItem has priority field that defaults to None</done>
</task>

<task type="auto">
  <name>Task 3: Update database schema and operations</name>
  <files>src/storage/database.rs</files>
  <action>
1. Add `priority TEXT` column to both `todos` and `archived_todos` CREATE TABLE statements
2. Add ALTER TABLE migration for existing databases (like existing collapsed/completed_at/deleted_at migrations)
3. Update TodoRowData struct to include priority field
4. Update TodoRowData::from_row to read priority column
5. Update TodoRowData::into_todo_item to set priority field using Priority::from_db_str
6. Update save_todo_list INSERT statement to include priority column
7. Update save_todo_list stmt.execute params to include item.priority.to_db_str()

Database stores: NULL for None, "P0"/"P1"/"P2" for priorities.
  </action>
  <verify>cargo test database -- passes; cargo build passes</verify>
  <done>Priority persists to/from SQLite database</done>
</task>

<task type="auto">
  <name>Task 4: Update markdown serialization</name>
  <files>src/storage/markdown.rs</files>
  <action>
1. In serialize_todo_list_clean: Add priority suffix after content, before due_date
   - Format: " @priority(P0)" or " @priority(P1)" or " @priority(P2)"
   - Only add if priority is Some (not None)

2. Add parse_priority function similar to parse_due_date:
   - Look for @priority(P0/P1/P2) in content
   - Extract priority value
   - Return cleaned content and Option<Priority>

3. In parse_todo_line: Call parse_priority after parse_due_date
   - Pass extracted priority to TodoItem::full()

Update tests to cover priority serialization round-trip.
  </action>
  <verify>cargo test markdown -- passes; cargo test -- passes</verify>
  <done>Priority serializes to/from markdown files</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo build` succeeds without errors
- [ ] `cargo test` passes all tests
- [ ] `cargo clippy` has no warnings
- [ ] Priority enum has None/P0/P1/P2 variants
- [ ] TodoItem has priority field
- [ ] Database migrations work (test with fresh db and existing db)
- [ ] Markdown round-trip preserves priority
</verification>

<success_criteria>

- All tasks completed
- Priority data model exists and is usable
- Database and markdown serialization work
- No compiler errors or warnings
- Existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-todo-priority-system/03-01-SUMMARY.md`
</output>
