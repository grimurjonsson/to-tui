---
phase: 03-todo-priority-system
plan: 04
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - src/keybindings/mod.rs
  - src/app/state.rs
  - src/todo/list.rs
autonomous: true

must_haves:
  truths:
    - "User can press 's' to sort todos by priority"
    - "Sort order: P0 first, then P1, then P2, then no-priority"
    - "Children remain grouped under their parent after sort"
    - "Status bar confirms sort operation"
  artifacts:
    - path: "src/keybindings/mod.rs"
      provides: "SortByPriority action"
      contains: "SortByPriority"
    - path: "src/app/state.rs"
      provides: "sort_by_priority method"
      contains: "sort_by_priority"
    - path: "src/todo/list.rs"
      provides: "sort_by_priority method on TodoList"
      contains: "sort_by_priority"
  key_links:
    - from: "src/keybindings/mod.rs"
      to: "src/app/state.rs"
      via: "Action::SortByPriority triggers state.sort_by_priority()"
      pattern: "SortByPriority"
    - from: "src/app/state.rs"
      to: "src/todo/list.rs"
      via: "self.todo_list.sort_by_priority()"
      pattern: "sort_by_priority"
---

<objective>
Implement 's' key to sort todos by priority.

Purpose: Allow users to organize their list by importance.
Output: Sort action, keybinding, and hierarchy-aware sort algorithm.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plans for context
@.planning/phases/03-todo-priority-system/03-01-SUMMARY.md
@.planning/phases/03-todo-priority-system/03-02-SUMMARY.md

@src/keybindings/mod.rs
@src/app/state.rs
@src/app/event.rs
@src/todo/list.rs
@src/todo/hierarchy.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SortByPriority action and keybinding</name>
  <files>src/keybindings/mod.rs</files>
  <action>
1. Add `SortByPriority` variant to the Action enum (after CyclePriority)

2. Add Display impl case: `Action::SortByPriority => "sort_by_priority"`

3. Add FromStr impl case: `"sort_by_priority" => Ok(Action::SortByPriority)`

4. In default_navigate_bindings():
   - Add: `m.insert("s".to_string(), "sort_by_priority".to_string())`
  </action>
  <verify>cargo build --lib passes</verify>
  <done>SortByPriority action exists, bound to 's' key</done>
</task>

<task type="auto">
  <name>Task 2: Implement sort_by_priority on TodoList</name>
  <files>src/todo/list.rs</files>
  <action>
Add method to TodoList that sorts items by priority while preserving hierarchy:

```rust
/// Sort todos by priority, keeping children grouped with their parents.
/// Sort order: P0 (highest) -> P1 -> P2 -> None (lowest)
/// Within same priority, maintains original relative order (stable sort).
pub fn sort_by_priority(&mut self) {
    // Get root items (indent_level == 0)
    // Sort roots by priority
    // For each root, collect its subtree
    // Rebuild items list with sorted roots and their children
}
```

Algorithm:
1. Identify all root items (indent_level == 0)
2. Build subtree for each root (all consecutive items with indent_level > 0 until next root)
3. Sort roots by priority: P0 < P1 < P2 < None (so P0 comes first)
4. Reconstruct items: for each sorted root, append root then its subtree

Priority sort key function:
```rust
fn priority_sort_key(priority: Option<Priority>) -> u8 {
    match priority {
        Some(Priority::P0) => 0,
        Some(Priority::P1) => 1,
        Some(Priority::P2) => 2,
        None => 3,
    }
}
```

Use stable sort to preserve relative order within same priority level.

After rebuilding items, call recalculate_parent_ids() to fix parent references.
  </action>
  <verify>cargo test list -- passes</verify>
  <done>TodoList has sort_by_priority method that preserves hierarchy</done>
</task>

<task type="auto">
  <name>Task 3: Implement sort_by_priority in AppState and wire to event</name>
  <files>src/app/state.rs, src/app/event.rs</files>
  <action>
In src/app/state.rs, add method:

```rust
pub fn sort_by_priority(&mut self) {
    if self.is_readonly() {
        return;
    }

    self.save_undo_state();
    self.todo_list.sort_by_priority();
    self.cursor_position = 0; // Reset cursor to top after sort
    self.sync_list_state();
    self.status_message = Some("Sorted by priority".to_string());
}
```

In src/app/event.rs, add case in Navigate mode match:

```rust
Action::SortByPriority => {
    state.sort_by_priority();
}
```
  </action>
  <verify>cargo build passes; cargo test passes</verify>
  <done>Pressing 's' sorts todos by priority</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo build` succeeds without errors
- [ ] `cargo test` passes all tests
- [ ] `cargo clippy` has no warnings
- [ ] Pressing 's' sorts todos by priority (P0 first)
- [ ] Children remain grouped under their parent after sort
- [ ] Parent-child relationships (parent_id) are correct after sort
- [ ] Undo works after sort
- [ ] Status bar shows "Sorted by priority"
</verification>

<success_criteria>

- All tasks completed
- 's' key triggers priority sort
- Sort preserves parent-child grouping
- Parent IDs are recalculated correctly
- Undo functionality works
</success_criteria>

<output>
After completion, create `.planning/phases/03-todo-priority-system/03-04-SUMMARY.md`
</output>
