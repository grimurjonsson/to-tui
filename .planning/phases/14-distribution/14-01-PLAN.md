---
phase: 14-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/plugin/installer.rs
  - src/plugin/mod.rs
  - src/cli.rs
  - src/main.rs
autonomous: true

must_haves:
  truths:
    - "Local plugin installation copies directory contents to plugins folder"
    - "Existing plugin installation detected with prompt for --force override"
    - "Plugin manifest validated before completing installation"
  artifacts:
    - path: "src/plugin/installer.rs"
      provides: "PluginInstaller module with local_install and PluginSource parsing"
      exports: ["PluginInstaller", "PluginSource", "InstallResult"]
  key_links:
    - from: "src/plugin/installer.rs"
      to: "src/plugin/manager.rs"
      via: "load_plugin_info for validation"
      pattern: "PluginManager::load_plugin_info"
---

<objective>
Implement local plugin installation with directory copy and source path parsing.

Purpose: Enable installing plugins from local directories for development and manual installs, establishing the foundation for remote installation in subsequent plans.

Output: PluginInstaller module with local_install function, PluginSource struct for path parsing, and CLI `plugin install` command wired up.
</objective>

<execution_context>
@/Users/gimmi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gimmi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-distribution/14-CONTEXT.md
@.planning/phases/14-distribution/14-RESEARCH.md

@src/plugin/manager.rs
@src/plugin/manifest.rs
@src/cli.rs
@src/utils/paths.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PluginInstaller module with local installation</name>
  <files>src/plugin/installer.rs, src/plugin/mod.rs</files>
  <action>
Create new file `src/plugin/installer.rs` with:

1. **PluginSource struct** for parsing install sources:
```rust
pub struct PluginSource {
    pub owner: Option<String>,     // For remote: "grimurjonsson"
    pub repo: Option<String>,      // For remote: "to-tui-plugins"
    pub plugin_name: String,       // "jira" or local dir name
    pub version: Option<String>,   // None = latest
    pub local_path: Option<PathBuf>, // For local installs
}

impl PluginSource {
    pub fn parse(source: &str) -> Result<Self>;  // Detect local path vs owner/repo/plugin format
    pub fn is_local(&self) -> bool;
}
```

2. **InstallResult struct**:
```rust
pub struct InstallResult {
    pub plugin_name: String,
    pub version: String,
    pub path: PathBuf,
}
```

3. **PluginInstaller struct** with methods:
- `install_from_local(source_dir: &Path, force: bool) -> Result<InstallResult>`:
  - Check source directory contains plugin.toml
  - Load and validate manifest using PluginManager::load_plugin_info
  - Check version compatibility (min_interface_version)
  - Check if plugin already exists in plugins dir (error unless force=true)
  - Copy entire directory recursively using `copy_dir_recursive`
  - Return InstallResult with plugin name, version, target path

4. **copy_dir_recursive helper** that copies all files from source to target dir

Key patterns from CONTEXT.md:
- Local installs copy files (no symlinks)
- Plugins enabled by default after install
- Validate manifest before completing install
- Check for existing installation, require --force to overwrite

Export from mod.rs: `pub mod installer;`
  </action>
  <verify>
Run `cargo check` to verify compilation.
Run `cargo test --lib -- installer` to verify any unit tests pass.
  </verify>
  <done>
PluginInstaller module exists with PluginSource parsing and local_install method that copies validated plugin directories to the plugins folder.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire CLI install command for local paths</name>
  <files>src/cli.rs, src/main.rs</files>
  <action>
1. **Extend PluginCommand enum** in `src/cli.rs`:
```rust
/// Install a plugin from local directory or GitHub
Install {
    /// Plugin source: local path or owner/repo/plugin-name
    source: String,
    /// Version to install (remote only, default: latest)
    #[arg(long)]
    version: Option<String>,
    /// Overwrite existing installation
    #[arg(long)]
    force: bool,
},
```

2. **Add install handling** in `src/main.rs` where PluginCommand is matched:
```rust
PluginCommand::Install { source, version, force } => {
    let plugin_source = PluginSource::parse(&source)?;

    if plugin_source.is_local() {
        let result = PluginInstaller::install_from_local(
            plugin_source.local_path.as_ref().unwrap(),
            force
        )?;
        println!("Installed plugin '{}' v{} to {:?}",
            result.plugin_name, result.version, result.path);
    } else {
        // Remote install - implemented in plan 14-02
        anyhow::bail!("Remote plugin installation not yet implemented. \
            Use a local directory path for now.");
    }
    Ok(())
}
```

Import PluginInstaller and PluginSource from `crate::plugin::installer`.
  </action>
  <verify>
Run `cargo build` to verify compilation.
Test local install manually: `cargo run -- plugin install /path/to/test-plugin`
  </verify>
  <done>
CLI `totui plugin install <path>` works for local directories, copying plugin files to ~/.local/share/to-tui/plugins/ after validation.
  </done>
</task>

</tasks>

<verification>
1. `cargo test` - All existing tests still pass
2. `cargo clippy` - No new warnings
3. Manual test: Create a test plugin directory with valid plugin.toml, run `cargo run -- plugin install /path/to/plugin`, verify plugin appears in plugins directory
4. Manual test: Try to install same plugin again without --force, verify error message
5. Manual test: Try to install with --force, verify it overwrites
</verification>

<success_criteria>
- PluginInstaller module compiles with local installation support
- PluginSource correctly parses local paths vs remote formats
- CLI `plugin install` command accepts local directory paths
- Installation validates plugin manifest before copying
- Existing plugin detection works with --force override
- All existing tests pass, no clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/14-distribution/14-01-SUMMARY.md`
</output>
