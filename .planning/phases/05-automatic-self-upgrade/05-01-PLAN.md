---
phase: 05-automatic-self-upgrade
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - src/utils/mod.rs
  - src/utils/upgrade.rs
autonomous: true

must_haves:
  truths:
    - "Download function can fetch binary from GitHub releases URL"
    - "Progress updates are sent via channel during download"
    - "UpgradeSubState enum captures all workflow states"
  artifacts:
    - path: "src/utils/upgrade.rs"
      provides: "Download logic, progress channel, state types"
      exports: ["UpgradeSubState", "DownloadProgress", "spawn_download", "get_asset_download_url"]
    - path: "Cargo.toml"
      provides: "self_update, futures-util, and tempfile dependencies"
      contains: "self_update"
  key_links:
    - from: "src/utils/upgrade.rs"
      to: "GitHub releases"
      via: "reqwest HTTP client"
      pattern: "reqwest::Client"
---

<objective>
Create the upgrade module with download infrastructure and state types.

Purpose: Establish the foundation for async binary downloads with progress tracking that integrates with the TUI event loop.
Output: `src/utils/upgrade.rs` with UpgradeSubState enum, DownloadProgress messages, and spawn_download() function.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-automatic-self-upgrade/05-RESEARCH.md

# Existing version check pattern
@src/utils/version_check.rs

# Current Cargo.toml for dependencies
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dependencies to Cargo.toml</name>
  <files>Cargo.toml</files>
  <action>
Add the following dependencies to the `[dependencies]` section (NOT dev-dependencies):
- `self_update = { version = "0.41", default-features = false, features = ["rustls", "archive-tar", "compression-flate2"] }`
- `futures-util = "0.3"` (needed for StreamExt to enable streaming downloads with progress)
- `tempfile = "3.13"` (move from dev-dependencies to regular dependencies - needed for extract_binary() in Plan 03 to create stable temp directories for extracted binaries)

Note: Use `default-features = false` with explicit rustls feature to avoid OpenSSL dependency. The project already uses reqwest with rustls-tls.

Note: `tempfile` already exists as a dev-dependency (line 45). It must be added to regular `[dependencies]` because Plan 03's `extract_binary()` function needs it at runtime to safely manage temp directories with proper cleanup.
  </action>
  <verify>`cargo check` passes without errors</verify>
  <done>All three dependencies added to [dependencies] section and project compiles</done>
</task>

<task type="auto">
  <name>Task 2: Create upgrade module with types and download logic</name>
  <files>src/utils/upgrade.rs, src/utils/mod.rs</files>
  <action>
Create `src/utils/upgrade.rs` with:

1. **UpgradeSubState enum** (derives Debug, Clone):
   - `Prompt` - Initial state, showing Y/N/S options (current behavior)
   - `Downloading { progress: f64, bytes_downloaded: u64, total_bytes: Option<u64> }` - Shows progress bar
   - `Error { message: String }` - Download failed, show retry option
   - `RestartPrompt { downloaded_path: PathBuf }` - Download complete, ask to restart

2. **DownloadProgress enum** (for channel messages):
   - `Progress { bytes: u64, total: Option<u64> }`
   - `Complete { path: PathBuf }`
   - `Error { message: String }`

3. **get_asset_download_url(version: &str) -> String** function:
   - Uses `cfg!(target_os)` and `cfg!(target_arch)` for platform detection
   - Returns URL like: `https://github.com/grimurjonsson/to-tui/releases/download/v{version}/totui-{target}.tar.gz`
   - Supported targets:
     - macOS ARM: `aarch64-apple-darwin`
     - macOS Intel: `x86_64-apple-darwin`
     - Linux: `x86_64-unknown-linux-gnu`
   - Panic on unsupported platforms with clear message

4. **spawn_download(url: String, target_path: PathBuf) -> tokio::sync::mpsc::Receiver<DownloadProgress>** function:
   - Creates mpsc channel with buffer size 32
   - Spawns tokio task that:
     - Creates reqwest::Client
     - Sends GET request with User-Agent "to-tui" and Accept "application/octet-stream"
     - Gets content_length() for total
     - Uses response.bytes_stream() with futures_util::StreamExt for chunked reading
     - Writes chunks to file
     - Sends Progress updates (rate-limit to max ~10/sec by only sending every 100KB or when complete)
     - Sends Complete or Error at end
   - Returns receiver

5. **format_bytes(bytes: u64) -> String** helper:
   - Returns human-readable format (e.g., "1.5 MB", "256 KB", "100 B")

Add `pub mod upgrade;` to `src/utils/mod.rs`.

Reference the research document patterns but adapt for the existing project style (anyhow::Result, etc.).
  </action>
  <verify>
`cargo check` passes. Run `cargo test` to ensure no regressions. The module compiles without errors.
  </verify>
  <done>
- UpgradeSubState enum exists with all four variants
- DownloadProgress enum exists with three variants
- get_asset_download_url() returns correct URLs for darwin/linux
- spawn_download() compiles and returns mpsc receiver
- format_bytes() helper exists
- Module exported from utils/mod.rs
  </done>
</task>

</tasks>

<verification>
- [ ] `cargo check` passes
- [ ] `cargo test` passes (no regressions)
- [ ] `src/utils/upgrade.rs` exists with all types and functions
- [ ] Dependencies added to Cargo.toml [dependencies] section (not dev-dependencies)
</verification>

<success_criteria>
Foundation for upgrade system exists:
- UpgradeSubState can represent all workflow states
- Download can be spawned as async task with progress channel
- Platform-specific download URLs are correctly constructed
- tempfile crate available at runtime for Plan 03
</success_criteria>

<output>
After completion, create `.planning/phases/05-automatic-self-upgrade/05-01-SUMMARY.md`
</output>
