---
phase: 15-migration
plan: 03
type: execute
wave: 2
depends_on: ["15-02"]
files_modified:
  - src/app/state.rs
  - src/app/event.rs
  - src/ui/components/plugin_modal.rs
  - src/ui/components/mod.rs
autonomous: false  # Has checkpoint:human-verify

must_haves:
  truths:
    - "P key opens a tabbed modal with Installed and Marketplace tabs"
    - "Installed tab shows installed plugins with status indicators and version"
    - "Marketplace tab shows available plugins from registry"
    - "Plugin invocation works through new modal for external plugins"
  artifacts:
    - path: "src/ui/components/plugin_modal.rs"
      provides: "Tabbed plugins modal rendering"
      contains: "PluginsTab"
    - path: "src/app/state.rs"
      provides: "PluginsModalState enum"
      contains: "PluginsModalState"
  key_links:
    - from: "src/app/event.rs"
      to: "src/app/state.rs"
      via: "Tab navigation handling"
      pattern: "handle_plugins_modal"
    - from: "src/ui/components/plugin_modal.rs"
      to: "ratatui::widgets::Tabs"
      via: "Tab widget rendering"
      pattern: "Tabs::new"
    - from: "src/app/state.rs"
      to: "src/plugin/marketplace.rs"
      via: "Marketplace fetch on tab switch"
      pattern: "fetch_marketplace_plugins"
---

<objective>
Implement a tabbed plugins modal for P-key invocation with Installed and Marketplace tabs.

Purpose: Provide a polished UI for plugin discovery and invocation, completing the v2.0 plugin framework.

Output: P key opens a modern modal with [Installed] and [Marketplace] tabs, supporting both installed plugin invocation and new plugin discovery.
</objective>

<execution_context>
@/Users/gimmi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gimmi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-migration/15-CONTEXT.md
@.planning/phases/15-migration/15-02-SUMMARY.md

## Reference: Current Plugin State
@src/plugin/mod.rs
@src/app/state.rs
@src/app/event.rs

## Reference: Marketplace
@src/plugin/marketplace.rs
@src/plugin/manager.rs
@src/plugin/loader.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement PluginsModalState</name>
  <files>
    src/app/state.rs
  </files>
  <action>
    Replace PluginSubState with new PluginsModalState that supports tabbed navigation:

    1. Add new types near top of state.rs:
       ```rust
       /// Tab selection in plugins modal
       #[derive(Debug, Clone, Copy, PartialEq, Eq)]
       pub enum PluginsTab {
           Installed,
           Marketplace,
       }

       /// State for the tabbed plugins modal
       #[derive(Debug, Clone)]
       pub enum PluginsModalState {
           /// Tab selection mode with list navigation
           Tabs {
               active_tab: PluginsTab,
               installed_index: usize,
               marketplace_index: usize,
               marketplace_plugins: Option<Vec<crate::plugin::marketplace::MarketplacePlugin>>,
               marketplace_loading: bool,
               marketplace_error: Option<String>,
           },
           /// Plugin details view (from Marketplace tab)
           Details {
               plugin: crate::plugin::marketplace::MarketplacePlugin,
           },
           /// Plugin input prompt (invoking installed plugin)
           Input {
               plugin_name: String,
               input_buffer: String,
               cursor_pos: usize,
           },
           /// Executing plugin
           Executing {
               plugin_name: String,
           },
           /// Preview generated items
           Preview {
               items: Vec<TodoItem>,
           },
           /// Error display
           Error {
               message: String,
           },
       }
       ```

    2. In AppState struct:
       - Keep `plugin_state: Option<PluginSubState>` but change to `plugins_modal_state: Option<PluginsModalState>`
       - Add `marketplace_fetch_rx: Option<mpsc::Receiver<Result<Vec<crate::plugin::marketplace::MarketplacePlugin>, String>>>`

    3. Add helper methods to AppState:
       ```rust
       /// Open plugins modal with Installed tab selected
       pub fn open_plugins_modal(&mut self) {
           // Get installed plugins from plugin_loader
           let installed_count = self.plugin_loader.loaded_plugins().count();

           self.plugins_modal_state = Some(PluginsModalState::Tabs {
               active_tab: PluginsTab::Installed,
               installed_index: 0,
               marketplace_index: 0,
               marketplace_plugins: None,
               marketplace_loading: false,
               marketplace_error: None,
           });
           self.mode = Mode::Plugin;
       }

       /// Close plugins modal
       pub fn close_plugins_modal(&mut self) {
           self.plugins_modal_state = None;
           self.marketplace_fetch_rx = None;
           self.mode = Mode::Navigate;
       }

       /// Start async marketplace fetch
       pub fn start_marketplace_fetch(&mut self) {
           use crate::plugin::marketplace::fetch_marketplace_manifest;
           use crate::config::Config;

           let (tx, rx) = mpsc::channel();
           self.marketplace_fetch_rx = Some(rx);

           // Get marketplace URL from config
           let marketplace_url = Config::load()
               .ok()
               .and_then(|c| c.marketplaces.as_ref().map(|m| m.default.clone()))
               .unwrap_or_else(|| "grimurjonsson/to-tui-plugins".to_string());

           std::thread::spawn(move || {
               let result = fetch_marketplace_manifest(&marketplace_url)
                   .map(|manifest| manifest.plugins)
                   .map_err(|e| e.to_string());
               let _ = tx.send(result);
           });

           // Update state to show loading
           if let Some(PluginsModalState::Tabs { marketplace_loading, .. }) = &mut self.plugins_modal_state {
               *marketplace_loading = true;
           }
       }
       ```

    4. Update open_plugin_menu() to call open_plugins_modal() instead

    5. Rename close_plugin_menu() to close_plugins_modal()
  </action>
  <verify>
    ```bash
    cargo check 2>&1 | head -50
    ```
  </verify>
  <done>
    PluginsModalState implemented with all variants, AppState updated with new fields and methods
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement plugins modal event handling</name>
  <files>
    src/app/event.rs
  </files>
  <action>
    Replace handle_plugin_mode with comprehensive modal handling:

    1. Update handle_plugin_mode to handle new state machine:
       ```rust
       fn handle_plugin_mode(key: KeyEvent, state: &mut AppState) -> Result<()> {
           let modal_state = match state.plugins_modal_state.take() {
               Some(ms) => ms,
               None => {
                   state.close_plugins_modal();
                   return Ok(());
               }
           };

           match modal_state {
               PluginsModalState::Tabs { .. } => handle_plugins_tabs(key, state, modal_state),
               PluginsModalState::Details { plugin } => handle_plugins_details(key, state, plugin),
               PluginsModalState::Input { plugin_name, input_buffer, cursor_pos } =>
                   handle_plugins_input(key, state, plugin_name, input_buffer, cursor_pos),
               PluginsModalState::Executing { plugin_name } => {
                   state.plugins_modal_state = Some(PluginsModalState::Executing { plugin_name });
                   Ok(())
               }
               PluginsModalState::Preview { items } => handle_plugins_preview(key, state, items),
               PluginsModalState::Error { message } => handle_plugins_error(key, state, message),
           }
       }
       ```

    2. Implement handle_plugins_tabs:
       - Tab/Shift+Tab: Switch between Installed and Marketplace tabs
       - j/k or Up/Down: Navigate list in current tab
       - Enter on Installed: Open input prompt for plugin
       - Enter on Marketplace: Show plugin details
       - Esc/q: Close modal
       - When switching to Marketplace tab, trigger fetch if not loaded

    3. Implement handle_plugins_details:
       - Esc/q/Backspace: Back to Marketplace tab
       - i: Install plugin (spawn install command)

    4. Implement handle_plugins_input (adapt from existing handle_plugin_input):
       - Use PluginLoader instead of PluginRegistry
       - Call plugin.generate() through FFI

    5. Update poll_plugin_result() to also check marketplace_fetch_rx and update state
  </action>
  <verify>
    ```bash
    cargo check 2>&1 | head -50
    ```
  </verify>
  <done>
    Event handling compiles, tab navigation works, plugin invocation through loader
  </done>
</task>

<task type="auto">
  <name>Task 3: Create plugins modal UI component</name>
  <files>
    src/ui/components/plugin_modal.rs
    src/ui/components/mod.rs
  </files>
  <action>
    1. Create src/ui/components/plugin_modal.rs with:
       - render_plugins_modal() main function
       - render_tabs_view() for tab header and content routing
       - render_installed_list() showing plugins with status indicator and version
       - render_marketplace_list() with loading spinner and error states
       - render_details_view() for marketplace plugin info with [i] Install hint
       - render_input_view() for plugin input prompt
       - render_executing_view() with spinner
       - render_preview_view() for generated items
       - render_error_view() for error display

    2. Update src/ui/components/mod.rs to add:
       ```rust
       pub mod plugin_modal;
       ```

    3. Update the main render function to call render_plugins_modal when in Plugin mode
  </action>
  <verify>
    ```bash
    cargo check 2>&1 | head -50
    ```
  </verify>
  <done>
    Plugins modal renders with tabs, installed list shows loaded plugins with version, marketplace shows fetched plugins
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete tabbed plugins modal with P key invocation:
    - Installed tab showing loaded plugins with version
    - Marketplace tab fetching from registry
    - Plugin invocation flow (select -> input -> execute -> preview -> accept)
  </what-built>
  <how-to-verify>
    1. Run the TUI: `cargo run`
    2. Press P to open plugins modal
    3. Verify "Installed" tab is selected by default
    4. If plugins are installed, verify they show with version numbers
    5. Press Tab to switch to "Marketplace" tab
    6. Verify marketplace loads (may show loading spinner, then plugins or empty state)
    7. Press Tab to return to "Installed" tab
    8. If a plugin is installed:
       a. Select it with j/k and press Enter
       b. Enter input (e.g., a Jira ticket ID for jira-claude)
       c. Press Enter to execute
       d. Verify spinner shows during execution
       e. Verify preview shows generated todos
       f. Press y to accept or n to cancel
    9. Press Esc to close modal
    10. Verify you return to normal navigation mode
  </how-to-verify>
  <resume-signal>Type "approved" if the P key flow works end-to-end, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. Code compiles: `cargo check` passes
2. Tests pass: `cargo test`
3. P key opens tabbed modal (checkpoint verification)
4. Tab navigation works between Installed and Marketplace
5. Plugin invocation works through new modal
</verification>

<success_criteria>
- P key opens tabbed plugins modal
- Installed tab shows plugins from PluginLoader with version
- Marketplace tab fetches and displays available plugins
- Plugin can be invoked from Installed tab
- Plugin details viewable from Marketplace tab
- E2E flow verified by user
</success_criteria>

<output>
After completion, create `.planning/phases/15-migration/15-03-SUMMARY.md`
</output>
