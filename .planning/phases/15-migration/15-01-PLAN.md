---
phase: 15-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  # External repo: grimurjonsson/to-tui-plugins
  - jira-claude/Cargo.toml
  - jira-claude/src/lib.rs
  - jira-claude/plugin.toml
  - jira-claude/README.md
  - jira-claude/CHANGELOG.md
  - .github/workflows/release.yml
  - marketplace.toml
  - LICENSE
  - README.md
autonomous: true

must_haves:
  truths:
    - "jira-claude crate compiles as cdylib implementing Plugin trait"
    - "Plugin manifest (plugin.toml) defines name, version, and permissions"
    - "Plugin release workflow is configured for multi-platform builds (triggered on tag push)"
    - "Placeholder marketplace.toml entry exists for jira-claude (populated by CI on first release)"
  artifacts:
    - path: "jira-claude/Cargo.toml"
      provides: "Plugin crate configuration with cdylib output"
      contains: 'crate-type = ["cdylib"]'
    - path: "jira-claude/src/lib.rs"
      provides: "Plugin implementation with FFI exports"
      contains: "#[export_root_module]"
    - path: "jira-claude/plugin.toml"
      provides: "Plugin manifest"
      contains: 'name = "jira-claude"'
    - path: ".github/workflows/release.yml"
      provides: "Multi-platform release workflow"
      contains: "jira-claude-v*"
    - path: "marketplace.toml"
      provides: "Registry manifest"
      contains: "[[plugins]]"
  key_links:
    - from: "jira-claude/src/lib.rs"
      to: "totui-plugin-interface"
      via: "Plugin trait implementation"
      pattern: "impl Plugin for JiraClaudePlugin"
    - from: ".github/workflows/release.yml"
      to: "marketplace.toml"
      via: "Release workflow updates manifest"
      pattern: "marketplace.toml"
---

<objective>
Create the jira-claude plugin as a standalone crate in the grimurjonsson/to-tui-plugins registry.

Purpose: Establish the first external plugin in the official registry, demonstrating the plugin development pattern and enabling automated builds.

Output: A fully functional jira-claude plugin ready for installation via `totui plugin install jira-claude`.

**Prerequisite:** The GitHub repository grimurjonsson/to-tui-plugins must exist. Task 1 attempts to create it via `gh repo create`, but this may fail if:
- The repository already exists (expected - just clone it)
- GitHub CLI is not authenticated (fallback: create manually at https://github.com/new)
These failures are expected in many scenarios and the plan handles them with fallback logic.
</objective>

<execution_context>
@/Users/gimmi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gimmi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-migration/15-CONTEXT.md
@.planning/phases/15-migration/15-RESEARCH.md

## Reference: Existing Jira Generator
@src/plugin/generators/jira_claude.rs
@src/plugin/subprocess.rs

## Reference: Plugin Interface
@crates/totui-plugin-interface/src/plugin.rs
@crates/totui-plugin-interface/src/types.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create jira-claude plugin crate</name>
  <files>
    jira-claude/Cargo.toml
    jira-claude/src/lib.rs
    jira-claude/plugin.toml
  </files>
  <action>
    IMPORTANT: This task creates files in a NEW REPOSITORY (grimurjonsson/to-tui-plugins), not the current to-tui repo.

    1. Create the grimurjonsson/to-tui-plugins repository on GitHub and clone it:
       ```bash
       cd ~/Documents/Sources/rust
       # Create GitHub repo if it doesn't exist (requires gh CLI authenticated)
       gh repo create grimurjonsson/to-tui-plugins --public --description "Official plugin registry for to-tui" || true
       # Clone the repo (creates local directory)
       git clone https://github.com/grimurjonsson/to-tui-plugins.git || (mkdir to-tui-plugins && cd to-tui-plugins && git init && git remote add origin https://github.com/grimurjonsson/to-tui-plugins.git)
       ```

       PREREQUISITE: If `gh repo create` fails due to authentication, manually create the repository at https://github.com/new with:
       - Repository name: to-tui-plugins
       - Owner: grimurjonsson
       - Visibility: Public

    2. Create jira-claude/Cargo.toml:
       ```toml
       [package]
       name = "jira-claude"
       version = "0.1.0"
       edition = "2021"
       description = "Generate todos from Jira tickets using Claude AI"
       license = "MIT"

       [lib]
       crate-type = ["cdylib"]

       [dependencies]
       totui-plugin-interface = { git = "https://github.com/grimurjonsson/to-tui", tag = "v0.4.0" }
       abi_stable = "0.11"
       serde = { version = "1.0", features = ["derive"] }
       serde_json = "1.0"
       ```

    3. Create jira-claude/src/lib.rs by extracting and adapting logic from src/plugin/generators/jira_claude.rs:
       - Import totui_plugin_interface types
       - Implement Plugin trait for JiraClaudePlugin
       - Export with #[export_root_module] macro
       - Keep subprocess logic (Command spawning for acli and claude)
       - Convert anyhow::Result to RResult for FFI safety

       Key implementation points:
       - Use std::process::Command directly (no subprocess module)
       - Return RResult<RVec<FfiTodoItem>, RString> from generate()
       - Implement all Plugin trait methods (config_schema returns empty, no event subscriptions)

    4. Create jira-claude/plugin.toml manifest:
       ```toml
       [plugin]
       name = "jira-claude"
       version = "0.1.0"
       description = "Generate todos from Jira tickets using Claude AI"
       author = "grimurjonsson"
       license = "MIT"
       min_interface_version = "0.1.0"

       [permissions]
       subprocess = true  # Runs acli and claude commands

       [dependencies]
       # External commands required
       acli = { type = "command", purpose = "Fetch Jira ticket data" }
       claude = { type = "command", purpose = "AI-powered todo generation" }
       ```
  </action>
  <verify>
    ```bash
    cd ~/Documents/Sources/rust/to-tui-plugins/jira-claude
    cargo check
    ```
  </verify>
  <done>
    jira-claude crate compiles without errors, implements Plugin trait with generate() method
  </done>
</task>

<task type="auto">
  <name>Task 2: Create documentation and registry files</name>
  <files>
    jira-claude/README.md
    jira-claude/CHANGELOG.md
    LICENSE
    README.md
    marketplace.toml
  </files>
  <action>
    1. Create jira-claude/README.md:
       ```markdown
       # jira-claude

       Generate todos from Jira tickets using Claude AI.

       ## Requirements

       - [acli](https://github.com/atlassian/acli) - Atlassian CLI for Jira access
       - [claude](https://claude.ai) - Claude CLI for AI generation

       ## Installation

       ```bash
       totui plugin install jira-claude
       ```

       ## Usage

       1. Press `P` in to-tui to open the plugins modal
       2. Select jira-claude from the Installed tab
       3. Enter a Jira ticket ID (e.g., PROJ-123)
       4. Review and accept the generated todos

       ## How it works

       1. Fetches ticket details via `acli jira workitem view`
       2. Extracts summary, description, and comments
       3. Sends to Claude CLI with a task breakdown prompt
       4. Parses JSON response into nested todo items
       5. Creates parent item with ticket link and summary
       ```

    2. Create jira-claude/CHANGELOG.md:
       ```markdown
       # Changelog

       ## [0.1.0] - 2026-01-26

       ### Added
       - Initial release
       - Generate todos from Jira tickets via acli + Claude CLI
       - Support for nested subtasks based on ticket complexity
       - Ticket description and URL in parent todo
       ```

    3. Create LICENSE (MIT) at repo root

    4. Create README.md at repo root:
       ```markdown
       # to-tui-plugins

       Official plugin registry for [to-tui](https://github.com/grimurjonsson/to-tui).

       ## Available Plugins

       | Plugin | Description | Version |
       |--------|-------------|---------|
       | [jira-claude](./jira-claude) | Generate todos from Jira tickets using Claude AI | 0.1.0 |

       ## Installing Plugins

       ```bash
       # Install from registry
       totui plugin install jira-claude

       # List installed plugins
       totui plugin list
       ```

       ## For Plugin Authors

       See [to-tui documentation](https://github.com/grimurjonsson/to-tui/blob/main/docs/plugins.md) for plugin development guide.
       ```

    5. Create marketplace.toml PLACEHOLDER (will be auto-updated by CI on first release):
       ```toml
       # This is a placeholder - download URLs populated by CI after first release tag
       # When you push a tag like jira-claude-v0.1.0, the release workflow will:
       # 1. Build binaries for all platforms
       # 2. Create a GitHub release with the artifacts
       # 3. Update this file with actual download URLs
       # 4. Commit the updated marketplace.toml

       [[plugins]]
       name = "jira-claude"
       version = "0.1.0"
       description = "Generate todos from Jira tickets using Claude AI"
       # downloads section will be populated by release workflow
       ```

       NOTE: 15-02 depends on 15-01 CODE completion (crate files exist), NOT on the
       release being published. The marketplace.toml download URLs are only available
       AFTER the first release tag is pushed and CI runs.
  </action>
  <verify>
    ```bash
    cd ~/Documents/Sources/rust/to-tui-plugins
    ls -la jira-claude/README.md jira-claude/CHANGELOG.md LICENSE README.md marketplace.toml
    ```
  </verify>
  <done>
    All documentation files exist with correct content
  </done>
</task>

<task type="auto">
  <name>Task 3: Create GitHub Actions release workflow</name>
  <files>
    .github/workflows/release.yml
  </files>
  <action>
    Create .github/workflows/release.yml for multi-platform builds:

    ```yaml
    name: Release Plugin

    on:
      push:
        tags:
          - 'jira-claude-v*'

    permissions:
      contents: write

    jobs:
      build:
        strategy:
          matrix:
            include:
              - os: ubuntu-latest
                target: x86_64-unknown-linux-gnu
                use_cross: false
              - os: ubuntu-latest
                target: aarch64-unknown-linux-gnu
                use_cross: true
              - os: macos-latest
                target: x86_64-apple-darwin
                use_cross: false
              - os: macos-latest
                target: aarch64-apple-darwin
                use_cross: false
              - os: windows-latest
                target: x86_64-pc-windows-msvc
                use_cross: false

        runs-on: ${{ matrix.os }}

        steps:
          - uses: actions/checkout@v4

          - name: Install Rust
            uses: dtolnay/rust-toolchain@stable
            with:
              targets: ${{ matrix.target }}

          - name: Install cross
            if: matrix.use_cross
            run: cargo install cross --git https://github.com/cross-rs/cross

          - name: Build plugin
            working-directory: jira-claude
            run: |
              if [ "${{ matrix.use_cross }}" = "true" ]; then
                cross build --release --target ${{ matrix.target }}
              else
                cargo build --release --target ${{ matrix.target }}
              fi
            shell: bash

          - name: Package (Unix)
            if: runner.os != 'Windows'
            run: |
              mkdir -p dist
              # Find the library file (could be .so or .dylib)
              LIB_FILE=$(find target/${{ matrix.target }}/release -maxdepth 1 -name "libjira_claude.*" -type f | head -1)
              tar -czvf dist/jira-claude-${{ matrix.target }}.tar.gz \
                -C jira-claude plugin.toml README.md \
                -C ../$(dirname $LIB_FILE) $(basename $LIB_FILE)

          - name: Package (Windows)
            if: runner.os == 'Windows'
            shell: pwsh
            run: |
              New-Item -ItemType Directory -Force -Path dist
              $lib = Get-ChildItem -Path "target/${{ matrix.target }}/release" -Filter "jira_claude.dll" | Select-Object -First 1
              Compress-Archive -Path "jira-claude/plugin.toml", "jira-claude/README.md", $lib.FullName -DestinationPath "dist/jira-claude-${{ matrix.target }}.zip"

          - name: Upload artifact
            uses: actions/upload-artifact@v4
            with:
              name: jira-claude-${{ matrix.target }}
              path: dist/*

      release:
        needs: build
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4

          - name: Download all artifacts
            uses: actions/download-artifact@v4
            with:
              path: artifacts

          - name: Collect release assets
            run: |
              mkdir -p release-assets
              find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec cp {} release-assets/ \;
              ls -la release-assets/

          - name: Create GitHub Release
            uses: softprops/action-gh-release@v2
            with:
              files: release-assets/*
              generate_release_notes: true

          - name: Update marketplace.toml
            run: |
              TAG="${GITHUB_REF_NAME}"
              VERSION="${TAG#jira-claude-v}"

              cat > marketplace.toml << 'EOF'
              # Auto-generated by CI after release

              [[plugins]]
              name = "jira-claude"
              version = "${VERSION}"
              description = "Generate todos from Jira tickets using Claude AI"

              [plugins.downloads]
              x86_64-unknown-linux-gnu = "https://github.com/grimurjonsson/to-tui-plugins/releases/download/${TAG}/jira-claude-x86_64-unknown-linux-gnu.tar.gz"
              aarch64-unknown-linux-gnu = "https://github.com/grimurjonsson/to-tui-plugins/releases/download/${TAG}/jira-claude-aarch64-unknown-linux-gnu.tar.gz"
              x86_64-apple-darwin = "https://github.com/grimurjonsson/to-tui-plugins/releases/download/${TAG}/jira-claude-x86_64-apple-darwin.tar.gz"
              aarch64-apple-darwin = "https://github.com/grimurjonsson/to-tui-plugins/releases/download/${TAG}/jira-claude-aarch64-apple-darwin.tar.gz"
              x86_64-pc-windows-msvc = "https://github.com/grimurjonsson/to-tui-plugins/releases/download/${TAG}/jira-claude-x86_64-pc-windows-msvc.zip"
              EOF

              # Replace placeholders
              sed -i "s/\${VERSION}/$VERSION/g" marketplace.toml
              sed -i "s/\${TAG}/$TAG/g" marketplace.toml

          - name: Commit marketplace.toml
            run: |
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git add marketplace.toml
              git commit -m "chore: update marketplace.toml for ${GITHUB_REF_NAME}" || echo "No changes"
              git push
    ```
  </action>
  <verify>
    ```bash
    cd ~/Documents/Sources/rust/to-tui-plugins
    cat .github/workflows/release.yml | head -50
    ```
  </verify>
  <done>
    Release workflow file exists with multi-platform matrix and marketplace update job
  </done>
</task>

</tasks>

<verification>
1. Plugin crate compiles: `cd jira-claude && cargo check`
2. All required files exist in repository
3. Workflow file is valid YAML
4. marketplace.toml has plugin entry
</verification>

<success_criteria>
- jira-claude crate implements Plugin trait with working generate() method
- Plugin compiles as cdylib without errors
- GitHub Actions workflow defined for all 5 target platforms
- marketplace.toml ready for publication (will be updated on first release)
- Repository ready for initial commit and tag
</success_criteria>

<output>
After completion, create `.planning/phases/15-migration/15-01-SUMMARY.md`
</output>
