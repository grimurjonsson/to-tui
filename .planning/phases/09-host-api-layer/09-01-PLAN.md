---
phase: 09-host-api-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/totui-plugin-interface/src/host_api.rs
  - crates/totui-plugin-interface/src/types.rs
  - crates/totui-plugin-interface/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "FfiCommand enum exists with Create, Update, Delete, Move variants"
    - "HostApi trait is FFI-safe via sabi_trait"
    - "FfiProjectContext, FfiTodoQuery, FfiTodoNode types exist with StableAbi"
    - "Plugin trait extended with execute_with_host method"
  artifacts:
    - path: "crates/totui-plugin-interface/src/host_api.rs"
      provides: "FfiCommand, HostApi trait, query types"
      exports: ["FfiCommand", "HostApi", "HostApi_TO", "FfiProjectContext", "FfiTodoQuery", "FfiTodoNode", "FfiStateFilter", "FfiMovePosition"]
    - path: "crates/totui-plugin-interface/src/types.rs"
      provides: "Extended FfiTodoItem with position field"
      contains: "pub position:"
    - path: "crates/totui-plugin-interface/src/lib.rs"
      provides: "Re-exports for host_api module"
      contains: "pub mod host_api"
  key_links:
    - from: "crates/totui-plugin-interface/src/host_api.rs"
      to: "crates/totui-plugin-interface/src/types.rs"
      via: "uses FfiTodoItem, FfiTodoState, FfiPriority"
      pattern: "use crate::types::"
---

<objective>
Define FFI-safe types for the plugin Host API including command enum, query types, and the HostApi trait.

Purpose: Establish the FFI contract that plugins will use to query and mutate todos. This is the foundation for plans 09-02 and 09-03.
Output: New host_api.rs module in interface crate with all FFI types, extended Plugin trait with execute_with_host method.
</objective>

<execution_context>
@/Users/gimmi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gimmi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-host-api-layer/09-RESEARCH.md
@.planning/phases/09-host-api-layer/09-CONTEXT.md
@crates/totui-plugin-interface/src/lib.rs
@crates/totui-plugin-interface/src/types.rs
@crates/totui-plugin-interface/src/plugin.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create host_api.rs with FfiCommand and query types</name>
  <files>crates/totui-plugin-interface/src/host_api.rs</files>
  <action>
Create new file `crates/totui-plugin-interface/src/host_api.rs` with:

1. **FfiCommand enum** with `#[repr(C)]` and `#[derive(StableAbi, Clone)]`:
   - `CreateTodo { content: RString, parent_id: ROption<RString>, temp_id: ROption<RString>, state: FfiTodoState, priority: ROption<FfiPriority>, indent_level: u32 }`
   - `UpdateTodo { id: RString, content: ROption<RString>, state: ROption<FfiTodoState>, priority: ROption<FfiPriority>, due_date: ROption<RString>, description: ROption<RString> }`
   - `DeleteTodo { id: RString }`
   - `MoveTodo { id: RString, position: FfiMovePosition }`

2. **FfiMovePosition enum** with `#[repr(C)]` and `#[derive(StableAbi, Clone)]`:
   - `Before { target_id: RString }`
   - `After { target_id: RString }`
   - `AtIndex { index: u32 }`

3. **FfiProjectContext struct** with `#[repr(C)]` and `#[derive(StableAbi, Clone)]`:
   - `id: RString` (UUID as string)
   - `name: RString`
   - `created_at: i64` (Unix millis)

4. **FfiTodoQuery struct** with `#[repr(C)]` and `#[derive(StableAbi, Clone, Default)]`:
   - `project: ROption<RString>` (None = current project)
   - `state_filter: ROption<FfiStateFilter>`
   - `parent_id: ROption<RString>` (filter by parent UUID)
   - `include_deleted: bool`
   - `date_from: ROption<RString>` (YYYY-MM-DD)
   - `date_to: ROption<RString>` (YYYY-MM-DD)

5. **FfiStateFilter enum** with `#[repr(u8)]` and `#[derive(StableAbi, Clone, Copy)]`:
   - `Done = 0` (only Checked)
   - `Pending = 1` (all non-Checked)
   - `All = 2`

6. **FfiTodoNode struct** with `#[repr(C)]` and `#[derive(StableAbi, Clone)]`:
   - `item: FfiTodoItem`
   - `children: RVec<FfiTodoNode>`
   - `position: u32`

Import from abi_stable: `StableAbi`, `std_types::{ROption, RString, RVec}`.
Import from crate::types: `FfiTodoItem`, `FfiTodoState`, `FfiPriority`.
  </action>
  <verify>`cargo check -p totui-plugin-interface` compiles without errors</verify>
  <done>FfiCommand, FfiMovePosition, FfiProjectContext, FfiTodoQuery, FfiStateFilter, FfiTodoNode types exist with StableAbi derive</done>
</task>

<task type="auto">
  <name>Task 2: Add HostApi trait with sabi_trait</name>
  <files>crates/totui-plugin-interface/src/host_api.rs</files>
  <action>
Add to `host_api.rs`:

1. Import `sabi_trait` from `abi_stable`.

2. Define **HostApi trait** with `#[sabi_trait]`:
```rust
#[sabi_trait]
pub trait HostApi: Send + Sync {
    /// Get current project context
    fn current_project(&self) -> FfiProjectContext;

    /// List all available projects (where this plugin is enabled)
    fn list_projects(&self) -> RVec<FfiProjectContext>;

    /// Query todos with filters
    fn query_todos(&self, query: FfiTodoQuery) -> RVec<FfiTodoItem>;

    /// Get a single todo by UUID
    fn get_todo(&self, id: RString) -> ROption<FfiTodoItem>;

    /// Get todos as tree structure (children nested under parents)
    #[sabi(last_prefix_field)]
    fn query_todos_tree(&self) -> RVec<FfiTodoNode>;
}
```

Note: `#[sabi(last_prefix_field)]` on `query_todos_tree` for future extensibility (per decision 06-02).
The trait generates `HostApi_TO` type for FFI-safe trait objects.
  </action>
  <verify>`cargo check -p totui-plugin-interface` compiles, and `HostApi_TO` type is generated</verify>
  <done>HostApi trait exists with sabi_trait macro, methods for query operations</done>
</task>

<task type="auto">
  <name>Task 3: Add position field to FfiTodoItem and wire exports</name>
  <files>crates/totui-plugin-interface/src/types.rs, crates/totui-plugin-interface/src/lib.rs</files>
  <action>
1. In `types.rs`, add to FfiTodoItem struct:
   - `pub position: u32` field after `completed_at` (order index in list)

2. In `lib.rs`:
   - Add `pub mod host_api;`
   - Add re-exports:
     ```rust
     pub use host_api::{
         FfiCommand, FfiMovePosition, FfiProjectContext, FfiStateFilter,
         FfiTodoNode, FfiTodoQuery, HostApi, HostApi_TO,
     };
     ```

3. Update the main crate's ffi_convert.rs to set position to 0 in the From impl (will be set by host during query).
  </action>
  <verify>`cargo check` compiles the entire workspace. `cargo test -p totui-plugin-interface` passes.</verify>
  <done>FfiTodoItem has position field, host_api module exported from lib.rs</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `cargo check` - entire workspace compiles
2. `cargo test` - all tests pass including FFI conversion tests
3. `cargo clippy` - no warnings
4. Verify exports: `grep -r "HostApi_TO" crates/totui-plugin-interface/src/` shows the type exists
</verification>

<success_criteria>
- FfiCommand enum with CreateTodo, UpdateTodo, DeleteTodo, MoveTodo variants
- HostApi trait with sabi_trait generates HostApi_TO type
- All query/context types have StableAbi derive
- FfiTodoItem includes position field
- Workspace compiles and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-host-api-layer/09-01-SUMMARY.md`
</output>
