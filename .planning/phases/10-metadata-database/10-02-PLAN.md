---
phase: 10-metadata-database
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/totui-plugin-interface/src/host_api.rs
  - crates/totui-plugin-interface/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "FfiCommand has variants for SetTodoMetadata, SetProjectMetadata, DeleteTodoMetadata, DeleteProjectMetadata"
    - "HostApi trait has methods for get_todo_metadata, get_project_metadata, query_todos_by_metadata"
    - "All new types derive StableAbi for FFI safety"
  artifacts:
    - path: "crates/totui-plugin-interface/src/host_api.rs"
      provides: "FFI-safe metadata command variants and HostApi query methods"
      contains: "SetTodoMetadata"
    - path: "crates/totui-plugin-interface/src/host_api.rs"
      provides: "FfiTodoMetadata struct for batch query results"
      contains: "struct FfiTodoMetadata"
  key_links:
    - from: "crates/totui-plugin-interface/src/host_api.rs"
      to: "crates/totui-plugin-interface/src/types.rs"
      via: "imports FfiTodoItem"
      pattern: "use crate::types"
---

<objective>
Extend the FFI interface with metadata command variants and HostApi query methods.

Purpose: Define the plugin-facing API for metadata operations. Plugins will use these types to set/get metadata through the host. This must be FFI-safe via abi_stable.

Output: Extended FfiCommand enum with metadata variants, extended HostApi trait with metadata methods, and FfiTodoMetadata struct for batch results.
</objective>

<execution_context>
@/Users/gimmi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gimmi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-metadata-database/10-CONTEXT.md
@.planning/phases/10-metadata-database/10-RESEARCH.md

@crates/totui-plugin-interface/src/host_api.rs
@crates/totui-plugin-interface/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add metadata command variants to FfiCommand</name>
  <files>crates/totui-plugin-interface/src/host_api.rs</files>
  <action>
    Add four new variants to the `FfiCommand` enum:

    ```rust
    /// Set metadata for a todo item.
    SetTodoMetadata {
        /// UUID of the todo
        todo_id: RString,
        /// JSON data as string (validated by host)
        data: RString,
        /// If true, merge with existing data; if false, replace entirely
        merge: bool,
    },

    /// Set metadata for a project.
    SetProjectMetadata {
        /// Project name
        project_name: RString,
        /// JSON data as string (validated by host)
        data: RString,
        /// If true, merge with existing data; if false, replace entirely
        merge: bool,
    },

    /// Delete metadata for a todo item.
    DeleteTodoMetadata {
        /// UUID of the todo
        todo_id: RString,
    },

    /// Delete metadata for a project.
    DeleteProjectMetadata {
        /// Project name
        project_name: RString,
    },
    ```

    Add these AFTER the existing MoveTodo variant (before the closing brace of the enum).
  </action>
  <verify>`cargo build -p totui-plugin-interface` compiles</verify>
  <done>FfiCommand has SetTodoMetadata, SetProjectMetadata, DeleteTodoMetadata, DeleteProjectMetadata variants</done>
</task>

<task type="auto">
  <name>Task 2: Add FfiTodoMetadata struct for batch results</name>
  <files>crates/totui-plugin-interface/src/host_api.rs</files>
  <action>
    Add a new struct before the HostApi trait definition:

    ```rust
    // ============================================================================
    // FfiTodoMetadata - Result type for batch metadata queries
    // ============================================================================

    /// FFI-safe metadata result for batch queries.
    ///
    /// Contains a todo ID and its associated metadata JSON string.
    #[repr(C)]
    #[derive(StableAbi, Clone, Debug)]
    pub struct FfiTodoMetadata {
        /// UUID of the todo as string
        pub todo_id: RString,
        /// JSON metadata string (empty {} if no metadata)
        pub data: RString,
    }
    ```

    This struct is used for batch metadata query results.
  </action>
  <verify>`cargo build -p totui-plugin-interface` compiles</verify>
  <done>FfiTodoMetadata struct exists with todo_id and data fields</done>
</task>

<task type="auto">
  <name>Task 3: Extend HostApi trait with metadata query methods</name>
  <files>crates/totui-plugin-interface/src/host_api.rs</files>
  <action>
    Extend the HostApi trait with metadata query methods. The existing `query_todos_tree` has `#[sabi(last_prefix_field)]` which must be moved to the LAST method we add.

    Add these methods after `query_todos_tree`:

    ```rust
    /// Get metadata for a single todo (returns empty {} if none).
    /// Plugin only sees its own metadata (auto-namespaced by plugin name).
    fn get_todo_metadata(&self, todo_id: RString) -> RString;

    /// Get metadata for multiple todos (batch operation).
    /// Returns vec of (todo_id, data) pairs. Missing metadata returns {} data.
    fn get_todo_metadata_batch(&self, todo_ids: RVec<RString>) -> RVec<FfiTodoMetadata>;

    /// Get metadata for a project (returns empty {} if none).
    fn get_project_metadata(&self, project_name: RString) -> RString;

    /// Query todos that have metadata matching a key/value.
    /// The key is a JSON path (e.g., "ticket_id"), value is a JSON value string.
    fn query_todos_by_metadata(&self, key: RString, value: RString) -> RVec<FfiTodoItem>;

    /// List projects that have metadata for this plugin.
    #[sabi(last_prefix_field)]
    fn list_projects_with_metadata(&self) -> RVec<RString>;
    ```

    IMPORTANT: Remove `#[sabi(last_prefix_field)]` from `query_todos_tree` and add it to `list_projects_with_metadata` instead. This attribute must always be on the LAST method for ABI compatibility.
  </action>
  <verify>`cargo build -p totui-plugin-interface` compiles</verify>
  <done>HostApi trait has get_todo_metadata, get_todo_metadata_batch, get_project_metadata, query_todos_by_metadata, list_projects_with_metadata methods</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. `cargo build -p totui-plugin-interface` - compiles without errors
2. `cargo clippy -p totui-plugin-interface` - no warnings
3. Manual inspection: FfiCommand has 4 new metadata variants
4. Manual inspection: HostApi trait has 5 new metadata methods
5. Manual inspection: `#[sabi(last_prefix_field)]` is on the last method
</verification>

<success_criteria>
- FfiCommand enum has SetTodoMetadata, SetProjectMetadata, DeleteTodoMetadata, DeleteProjectMetadata variants
- FfiTodoMetadata struct exists with todo_id and data fields
- HostApi trait has all metadata query methods
- All types derive StableAbi for FFI safety
- `#[sabi(last_prefix_field)]` is correctly placed on the last HostApi method
- Interface crate compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/10-metadata-database/10-02-SUMMARY.md`
</output>
