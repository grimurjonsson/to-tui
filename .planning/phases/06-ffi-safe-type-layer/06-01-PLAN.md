---
phase: 06-ffi-safe-type-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - crates/totui-plugin-interface/Cargo.toml
  - crates/totui-plugin-interface/src/lib.rs
  - crates/totui-plugin-interface/src/types.rs
  - src/plugin/ffi_convert.rs
  - src/plugin/mod.rs
autonomous: true

must_haves:
  truths:
    - "FfiTodoItem struct compiles with #[derive(StableAbi)]"
    - "FfiTodoState and FfiPriority enums compile with #[derive(StableAbi)]"
    - "Native TodoItem can convert to FfiTodoItem without data loss"
    - "FfiTodoItem can convert back to native TodoItem"
  artifacts:
    - path: "crates/totui-plugin-interface/Cargo.toml"
      provides: "Interface crate with abi_stable dependency"
      contains: "abi_stable"
    - path: "crates/totui-plugin-interface/src/types.rs"
      provides: "FFI-safe type definitions"
      exports: ["FfiTodoItem", "FfiTodoState", "FfiPriority"]
    - path: "src/plugin/ffi_convert.rs"
      provides: "Bidirectional type conversion"
      contains: "impl From"
  key_links:
    - from: "crates/totui-plugin-interface/src/lib.rs"
      to: "crates/totui-plugin-interface/src/types.rs"
      via: "pub mod types"
      pattern: "pub mod types"
    - from: "src/plugin/ffi_convert.rs"
      to: "totui-plugin-interface"
      via: "dependency import"
      pattern: "use totui_plugin_interface"
---

<objective>
Create the totui-plugin-interface crate with FFI-safe type definitions for TodoItem, TodoState, and Priority. Implement bidirectional conversion between native types and FFI types.

Purpose: Establish the type foundation that enables dynamic plugin loading with stable ABI guarantees.
Output: Interface crate with FfiTodoItem, FfiTodoState, FfiPriority types and From/TryFrom implementations.
</objective>

<execution_context>
@/Users/gimmi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gimmi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ffi-safe-type-layer/06-CONTEXT.md
@.planning/phases/06-ffi-safe-type-layer/06-RESEARCH.md
@src/todo/item.rs
@src/todo/state.rs
@src/todo/priority.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create workspace and interface crate structure</name>
  <files>
    - Cargo.toml
    - crates/totui-plugin-interface/Cargo.toml
    - crates/totui-plugin-interface/src/lib.rs
  </files>
  <action>
  1. Convert root Cargo.toml to a workspace:
     - Add `[workspace]` section with `members = [".", "crates/totui-plugin-interface"]`
     - Add `resolver = "2"` to workspace section

  2. Create crates/totui-plugin-interface/Cargo.toml:
     ```toml
     [package]
     name = "totui-plugin-interface"
     version = "0.1.0"
     edition = "2024"

     [dependencies]
     abi_stable = "0.11"
     ```

  3. Create crates/totui-plugin-interface/src/lib.rs:
     - Add `pub mod types;`
     - Re-export types: `pub use types::{FfiTodoItem, FfiTodoState, FfiPriority};`

  4. Add interface crate as dependency to root Cargo.toml:
     ```toml
     totui-plugin-interface = { path = "crates/totui-plugin-interface" }
     ```
  </action>
  <verify>
  Run `cargo check -p totui-plugin-interface` - should succeed with no errors.
  Run `cargo build` - workspace structure is valid.
  </verify>
  <done>
  Workspace created with totui-plugin-interface crate. Both `cargo check -p totui-plugin-interface` and `cargo build` succeed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Define FFI-safe types with StableAbi</name>
  <files>crates/totui-plugin-interface/src/types.rs</files>
  <action>
  Create types.rs with FFI-safe equivalents of native types:

  1. FfiTodoState enum with #[repr(u8)] and #[derive(StableAbi)]:
     - Empty = 0, Checked = 1, Question = 2, Exclamation = 3, InProgress = 4, Cancelled = 5

  2. FfiPriority enum with #[repr(u8)] and #[derive(StableAbi)]:
     - P0 = 0, P1 = 1, P2 = 2

  3. FfiTodoItem struct with #[repr(C)] and #[derive(StableAbi)]:
     - id: RString (UUID as string)
     - content: RString
     - state: FfiTodoState
     - priority: ROption<FfiPriority>
     - due_date: ROption<RString> (YYYY-MM-DD format)
     - description: ROption<RString>
     - parent_id: ROption<RString> (UUID as string)
     - indent_level: u32 (not usize - not FFI-safe)
     - created_at: i64 (Unix timestamp millis)
     - modified_at: i64
     - completed_at: ROption<i64>

  Note: Exclude `collapsed` (UI-only) and `deleted_at` (host filters these) per CONTEXT.md decisions.

  Required derives on all types: Clone, Debug, StableAbi
  Additional on enums: Copy, PartialEq, Eq
  </action>
  <verify>
  Run `cargo check -p totui-plugin-interface` - all types compile with StableAbi.
  </verify>
  <done>
  FfiTodoItem, FfiTodoState, FfiPriority defined with #[derive(StableAbi)] and all compile successfully.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement bidirectional type conversion</name>
  <files>
    - src/plugin/ffi_convert.rs
    - src/plugin/mod.rs
  </files>
  <action>
  1. Create src/plugin/ffi_convert.rs:

     a) Import types:
        - `use totui_plugin_interface::{FfiTodoItem, FfiTodoState, FfiPriority};`
        - `use crate::todo::{TodoItem, TodoState, Priority};`
        - `use abi_stable::std_types::{ROption, RString};`
        - `use chrono::{TimeZone, Utc};`
        - `use uuid::Uuid;`
        - `use anyhow::{Context, Result};`

     b) TodoState <-> FfiTodoState conversion:
        - `impl From<TodoState> for FfiTodoState` - match all variants
        - `impl From<FfiTodoState> for TodoState` - match all variants

     c) Priority <-> FfiPriority conversion:
        - `impl From<Priority> for FfiPriority` - match P0/P1/P2
        - `impl From<FfiPriority> for Priority` - match all variants

     d) TodoItem -> FfiTodoItem conversion:
        - `impl From<&TodoItem> for FfiTodoItem`
        - Convert id to RString via `.to_string().into()`
        - Convert content to RString via `.clone().into()`
        - Convert due_date to ROption<RString> via `.map(|d| d.format("%Y-%m-%d").to_string().into()).into()`
        - Convert description to ROption<RString>
        - Convert parent_id to ROption<RString>
        - Convert indent_level to u32 via `as u32`
        - Convert timestamps to i64 via `.timestamp_millis()`

     e) FfiTodoItem -> TodoItem conversion (fallible):
        - `impl TryFrom<FfiTodoItem> for TodoItem`
        - Parse UUID from id string with context
        - Parse due_date from YYYY-MM-DD format if present
        - Parse parent_id UUID if present
        - Reconstruct DateTime from timestamp_millis
        - Set collapsed = false (UI-only default)
        - Set deleted_at = None (host never passes deleted items)

  2. Update src/plugin/mod.rs:
     - Add `pub mod ffi_convert;`
     - Add re-export: `pub use ffi_convert::*;`
  </action>
  <verify>
  Run `cargo test` - all existing tests pass.
  Run `cargo build` - conversion module compiles.
  </verify>
  <done>
  Bidirectional conversion between native types and FFI types implemented. TodoItem round-trips correctly: native -> FFI -> native preserves data (except UI-only fields).
  </done>
</task>

</tasks>

<verification>
1. `cargo check -p totui-plugin-interface` passes - interface crate valid
2. `cargo build` passes - workspace compiles
3. `cargo test` passes - no regression in existing functionality
4. Types verify FFI-safe: no usize fields, all use RString/ROption/i64 for FFI-unsafe types
</verification>

<success_criteria>
- Interface crate exists at crates/totui-plugin-interface/
- FfiTodoItem, FfiTodoState, FfiPriority compile with #[derive(StableAbi)]
- From/TryFrom implementations allow bidirectional conversion
- All tests pass, no clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/06-ffi-safe-type-layer/06-01-SUMMARY.md`
</output>
