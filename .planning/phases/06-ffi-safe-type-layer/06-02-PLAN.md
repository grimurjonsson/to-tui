---
phase: 06-ffi-safe-type-layer
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - crates/totui-plugin-interface/src/lib.rs
  - crates/totui-plugin-interface/src/plugin.rs
  - crates/totui-plugin-interface/src/version.rs
  - crates/totui-plugin-interface/Cargo.toml
autonomous: true

must_haves:
  truths:
    - "Plugin trait compiles with #[sabi_trait]"
    - "PluginModule implements RootModule for version checking"
    - "Version compatibility function correctly identifies compatible/incompatible versions"
    - "Panic handling wrapper catches plugin panics at FFI boundary"
  artifacts:
    - path: "crates/totui-plugin-interface/src/plugin.rs"
      provides: "Plugin trait definition"
      exports: ["Plugin", "Plugin_TO"]
      contains: "#[sabi_trait]"
    - path: "crates/totui-plugin-interface/src/version.rs"
      provides: "Version protocol and compatibility checking"
      exports: ["PluginModule", "PluginModule_Ref", "is_version_compatible"]
  key_links:
    - from: "crates/totui-plugin-interface/src/lib.rs"
      to: "crates/totui-plugin-interface/src/plugin.rs"
      via: "pub mod plugin"
      pattern: "pub mod plugin"
    - from: "crates/totui-plugin-interface/src/version.rs"
      to: "PluginModule"
      via: "RootModule implementation"
      pattern: "impl RootModule"
---

<objective>
Define the Plugin trait using #[sabi_trait] and implement RootModule-based version protocol for plugin compatibility checking. Add panic handling utilities for safe FFI boundary calls.

Purpose: Complete the FFI-safe foundation by defining how plugins are structured and how version compatibility is enforced at load time.
Output: Plugin trait, PluginModule, version compatibility checking, panic handling wrapper.
</objective>

<execution_context>
@/Users/gimmi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gimmi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ffi-safe-type-layer/06-CONTEXT.md
@.planning/phases/06-ffi-safe-type-layer/06-RESEARCH.md
@.planning/phases/06-ffi-safe-type-layer/06-01-SUMMARY.md
@crates/totui-plugin-interface/src/types.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define Plugin trait with #[sabi_trait]</name>
  <files>
    - crates/totui-plugin-interface/src/plugin.rs
    - crates/totui-plugin-interface/src/lib.rs
  </files>
  <action>
  1. Create crates/totui-plugin-interface/src/plugin.rs:

     a) Add imports:
        ```rust
        use abi_stable::sabi_trait;
        use abi_stable::std_types::{RResult, RString, RVec};
        use crate::types::FfiTodoItem;
        use std::fmt::Debug;
        ```

     b) Define Plugin trait with #[sabi_trait]:
        ```rust
        #[sabi_trait]
        pub trait Plugin: Send + Sync + Debug {
            /// Plugin name for display
            fn name(&self) -> RString;

            /// Plugin version (semver format)
            fn version(&self) -> RString;

            /// Minimum interface version this plugin requires
            fn min_interface_version(&self) -> RString;

            /// Generate todos from input
            /// Returns Vec of FfiTodoItem or error message
            #[sabi(last_prefix_field)]
            fn generate(&self, input: RString) -> RResult<RVec<FfiTodoItem>, RString>;
        }
        ```

        Note: #[sabi(last_prefix_field)] on generate() allows adding new methods in future versions.

  2. Update crates/totui-plugin-interface/src/lib.rs:
     - Add `pub mod plugin;`
     - Add re-export: `pub use plugin::{Plugin, Plugin_TO};`
  </action>
  <verify>
  Run `cargo check -p totui-plugin-interface` - Plugin trait compiles with sabi_trait.
  </verify>
  <done>
  Plugin trait defined with #[sabi_trait]. Exports Plugin and Plugin_TO (trait object type generated by macro).
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement PluginModule with RootModule for version protocol</name>
  <files>
    - crates/totui-plugin-interface/src/version.rs
    - crates/totui-plugin-interface/src/lib.rs
    - crates/totui-plugin-interface/Cargo.toml
  </files>
  <action>
  1. Add semver dependency to crates/totui-plugin-interface/Cargo.toml:
     ```toml
     semver = "1.0"
     ```

  2. Create crates/totui-plugin-interface/src/version.rs:

     a) Add imports:
        ```rust
        use abi_stable::{
            library::RootModule,
            package_version_strings,
            sabi_types::VersionStrings,
            std_types::RBox,
            StableAbi,
        };
        use crate::plugin::Plugin_TO;
        use semver::Version;
        ```

     b) Define PluginModule struct for library entry point:
        ```rust
        /// Plugin library module - loaded from .so/.dylib/.dll
        #[repr(C)]
        #[derive(StableAbi)]
        #[sabi(kind(Prefix(prefix_ref = PluginModule_Ref)))]
        pub struct PluginModule {
            /// Factory function to create plugin instance
            #[sabi(last_prefix_field)]
            pub create_plugin: extern "C" fn() -> Plugin_TO<'static, RBox<()>>,
        }
        ```

     c) Implement RootModule trait:
        ```rust
        impl RootModule for PluginModule_Ref {
            abi_stable::declare_root_module_statics!{PluginModule_Ref}

            const BASE_NAME: &'static str = "totui_plugin";
            const NAME: &'static str = "to-tui plugin interface";
            const VERSION_STRINGS: VersionStrings = package_version_strings!();
        }
        ```

     d) Add version compatibility checking function:
        ```rust
        /// Check if plugin's minimum interface version is compatible with host
        ///
        /// Compatibility rules (per CONTEXT.md):
        /// - Same major version required
        /// - Host version must be >= plugin's minimum version
        pub fn is_version_compatible(
            plugin_min_version: &str,
            host_version: &str,
        ) -> Result<bool, String> {
            let plugin_min = Version::parse(plugin_min_version)
                .map_err(|e| format!("Invalid plugin version '{}': {}", plugin_min_version, e))?;
            let host = Version::parse(host_version)
                .map_err(|e| format!("Invalid host version '{}': {}", host_version, e))?;

            // Compatible if same major and host >= plugin_min
            Ok(host.major == plugin_min.major && host >= plugin_min)
        }

        /// Current interface crate version
        pub const INTERFACE_VERSION: &str = env!("CARGO_PKG_VERSION");
        ```

  3. Update crates/totui-plugin-interface/src/lib.rs:
     - Add `pub mod version;`
     - Add re-exports:
       ```rust
       pub use version::{PluginModule, PluginModule_Ref, is_version_compatible, INTERFACE_VERSION};
       ```
  </action>
  <verify>
  Run `cargo check -p totui-plugin-interface` - PluginModule compiles with RootModule.
  Run `cargo test -p totui-plugin-interface` - version compatibility tests pass (add in next task).
  </verify>
  <done>
  PluginModule defined with RootModule implementation. Version compatibility checking function validates semver rules.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add panic handling and version tests</name>
  <files>
    - crates/totui-plugin-interface/src/version.rs
    - crates/totui-plugin-interface/src/plugin.rs
  </files>
  <action>
  1. Add panic handling wrapper to plugin.rs:

     ```rust
     use abi_stable::std_types::{RResult, RString, RVec, RBox};
     use std::panic::{catch_unwind, AssertUnwindSafe};
     use crate::types::FfiTodoItem;

     /// Wrapper for calling plugin.generate() safely
     /// Catches any panics and converts them to RResult::RErr
     pub fn call_plugin_generate(
         plugin: &Plugin_TO<'_, RBox<()>>,
         input: RString,
     ) -> RResult<RVec<FfiTodoItem>, RString> {
         let result = catch_unwind(AssertUnwindSafe(|| {
             plugin.generate(input)
         }));

         match result {
             Ok(r) => r,
             Err(panic_info) => {
                 // Extract panic message if possible
                 let msg = if let Some(s) = panic_info.downcast_ref::<&str>() {
                     format!("Plugin panicked: {}", s)
                 } else if let Some(s) = panic_info.downcast_ref::<String>() {
                     format!("Plugin panicked: {}", s)
                 } else {
                     "Plugin panicked with unknown error".to_string()
                 };
                 RResult::RErr(msg.into())
             }
         }
     }
     ```

  2. Add tests to version.rs:

     ```rust
     #[cfg(test)]
     mod tests {
         use super::*;

         #[test]
         fn test_compatible_same_major_same_version() {
             assert!(is_version_compatible("0.1.0", "0.1.0").unwrap());
         }

         #[test]
         fn test_compatible_same_major_host_newer() {
             assert!(is_version_compatible("0.1.0", "0.2.0").unwrap());
             assert!(is_version_compatible("0.1.0", "0.1.5").unwrap());
         }

         #[test]
         fn test_incompatible_different_major() {
             assert!(!is_version_compatible("1.0.0", "0.9.0").unwrap());
             assert!(!is_version_compatible("0.1.0", "1.0.0").unwrap());
         }

         #[test]
         fn test_incompatible_host_older() {
             assert!(!is_version_compatible("0.2.0", "0.1.0").unwrap());
         }

         #[test]
         fn test_invalid_version_string() {
             assert!(is_version_compatible("invalid", "0.1.0").is_err());
             assert!(is_version_compatible("0.1.0", "invalid").is_err());
         }

         #[test]
         fn test_interface_version_constant() {
             // Just verify it parses as valid semver
             Version::parse(INTERFACE_VERSION).expect("INTERFACE_VERSION should be valid semver");
         }
     }
     ```

  3. Update lib.rs to export panic handling function:
     - Add to re-exports: `pub use plugin::call_plugin_generate;`
  </action>
  <verify>
  Run `cargo test -p totui-plugin-interface` - all version compatibility tests pass.
  Run `cargo clippy -p totui-plugin-interface` - no warnings.
  </verify>
  <done>
  Panic handling wrapper catches plugin panics at FFI boundary. Version compatibility tests verify semver rules work correctly.
  </done>
</task>

</tasks>

<verification>
1. `cargo check -p totui-plugin-interface` passes
2. `cargo test -p totui-plugin-interface` passes - version tests succeed
3. `cargo clippy -p totui-plugin-interface` passes - no warnings
4. `cargo build` passes - full workspace compiles
5. Plugin trait has #[sabi_trait] annotation
6. PluginModule has RootModule implementation with version strings
</verification>

<success_criteria>
- Plugin trait defined with #[sabi_trait] and Plugin_TO type generated
- PluginModule implements RootModule with version protocol
- is_version_compatible() correctly identifies compatible/incompatible plugins
- Panic handling wrapper catches panics at FFI boundary
- All tests pass, no clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/06-ffi-safe-type-layer/06-02-SUMMARY.md`
</output>
