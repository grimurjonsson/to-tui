---
phase: 11-plugin-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/totui-plugin-interface/src/config.rs
  - crates/totui-plugin-interface/src/lib.rs
  - crates/totui-plugin-interface/src/plugin.rs
  - src/plugin/config.rs
  - src/plugin/mod.rs
  - src/utils/paths.rs
autonomous: true

must_haves:
  truths:
    - "FfiConfigValue enum supports string, integer, boolean, and string array types"
    - "Plugin trait has config_schema() and on_config_loaded() methods"
    - "Host can load and validate plugin config.toml against schema"
    - "Config path helper returns ~/.config/to-tui/plugins/<name>/config.toml"
  artifacts:
    - path: "crates/totui-plugin-interface/src/config.rs"
      provides: "FFI-safe config types"
      exports: ["FfiConfigValue", "FfiConfigType", "FfiConfigField", "FfiConfigSchema"]
    - path: "src/plugin/config.rs"
      provides: "Host-side config loading and validation"
      exports: ["PluginConfigLoader", "ConfigValue"]
    - path: "src/utils/paths.rs"
      provides: "Plugin config directory path helper"
      contains: "get_plugin_config_path"
  key_links:
    - from: "src/plugin/config.rs"
      to: "crates/totui-plugin-interface/src/config.rs"
      via: "use totui_plugin_interface::{FfiConfigSchema, FfiConfigValue}"
      pattern: "totui_plugin_interface::\\{.*FfiConfig"
---

<objective>
Define FFI-safe config types in totui-plugin-interface and implement host-side config loading with validation.

Purpose: Establish the type foundation for plugin configuration - both the FFI types that cross the plugin boundary and the host-side loader that reads/validates TOML config files.

Output: Two new modules (interface config types + host loader), path helper, and Plugin trait extension.
</objective>

<execution_context>
@/Users/gimmi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gimmi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-plugin-configuration/11-CONTEXT.md
@.planning/phases/11-plugin-configuration/11-RESEARCH.md
@crates/totui-plugin-interface/src/lib.rs
@crates/totui-plugin-interface/src/plugin.rs
@src/plugin/mod.rs
@src/utils/paths.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add FFI-safe config types to totui-plugin-interface</name>
  <files>crates/totui-plugin-interface/src/config.rs, crates/totui-plugin-interface/src/lib.rs</files>
  <action>
Create new config.rs module in totui-plugin-interface with FFI-safe types:

1. FfiConfigValue enum (#[repr(C)], #[derive(StableAbi, Clone, Debug)]):
   - String(RString)
   - Integer(i64)
   - Boolean(bool)
   - StringArray(RVec<RString>)

2. FfiConfigType enum (#[repr(u8)], #[derive(StableAbi, Clone, Copy, Debug, PartialEq, Eq)]):
   - String = 0
   - Integer = 1
   - Boolean = 2
   - StringArray = 3

3. FfiConfigField struct (#[repr(C)], #[derive(StableAbi, Clone, Debug)]):
   - name: RString
   - field_type: FfiConfigType
   - required: bool
   - default: ROption<FfiConfigValue>
   - description: ROption<RString>

4. FfiConfigSchema struct (#[repr(C)], #[derive(StableAbi, Clone, Debug)]):
   - fields: RVec<FfiConfigField>
   - config_required: bool

Update lib.rs to:
- Add `pub mod config;`
- Export all four types in the pub use statement

Import from abi_stable::std_types::{ROption, RString, RVec}.
  </action>
  <verify>cargo build -p totui-plugin-interface</verify>
  <done>FfiConfigValue, FfiConfigType, FfiConfigField, FfiConfigSchema all compile with StableAbi derive</done>
</task>

<task type="auto">
  <name>Task 2: Extend Plugin trait with config methods</name>
  <files>crates/totui-plugin-interface/src/plugin.rs</files>
  <action>
Add two new methods to the Plugin trait:

1. config_schema(&self) -> FfiConfigSchema
   - Returns the plugin's config schema
   - Plugins that need no config return FfiConfigSchema with empty fields and config_required: false
   - Add this BEFORE execute_with_host (not after, since execute_with_host has #[sabi(last_prefix_field)])

2. on_config_loaded(&self, config: RHashMap<RString, FfiConfigValue>)
   - Called after config is loaded and validated
   - Plugin stores config in internal state (e.g., Mutex<Option<Config>>)
   - Move #[sabi(last_prefix_field)] from execute_with_host to on_config_loaded (it must be on the last method)

Update imports to include RHashMap and the new config types.

Add a safe wrapper function call_plugin_on_config_loaded() that catches panics, following the existing pattern of call_plugin_generate and call_plugin_execute_with_host.
  </action>
  <verify>cargo build -p totui-plugin-interface</verify>
  <done>Plugin trait has config_schema() and on_config_loaded() methods with panic-safe wrapper</done>
</task>

<task type="auto">
  <name>Task 3: Implement host-side config loader and path helper</name>
  <files>src/plugin/config.rs, src/plugin/mod.rs, src/utils/paths.rs</files>
  <action>
Create src/plugin/config.rs with:

1. ConfigValue enum (host-side, non-FFI):
   - String(String)
   - Integer(i64)
   - Boolean(bool)
   - StringArray(Vec<String>)

2. PluginConfigLoader struct with methods:
   - load_and_validate(plugin_name: &str, schema: &FfiConfigSchema) -> Result<HashMap<String, ConfigValue>>
     - Get config path via get_plugin_config_path()
     - If file doesn't exist and schema.config_required, bail with clear error
     - If file doesn't exist and not required, return defaults
     - Read and parse TOML using toml::from_str
     - Validate each field against schema (type checking)
     - Return errors with field names: "{field}: expected {type}, got {actual}"
   - collect_defaults(schema: &FfiConfigSchema) -> HashMap<String, ConfigValue>
   - validate_field_type(field_name: &str, value: &toml::Value, expected: FfiConfigType) -> Result<ConfigValue>

3. to_ffi_config(config: &HashMap<String, ConfigValue>) -> RHashMap<RString, FfiConfigValue>
   - Convert host ConfigValue to FFI FfiConfigValue
   - Use RString::from() for strings, collect() for RVec

Add to src/utils/paths.rs:
- get_plugin_config_dir(plugin_name: &str) -> Result<PathBuf>
  - Returns dirs::config_dir()?.join("to-tui").join("plugins").join(plugin_name)
- get_plugin_config_path(plugin_name: &str) -> Result<PathBuf>
  - Returns get_plugin_config_dir(plugin_name)?.join("config.toml")

Update src/plugin/mod.rs to add `pub mod config;`

Add unit tests for:
- validate_field_type with each type (string, integer, boolean, string array)
- validate_field_type type mismatch errors include field name
- collect_defaults uses default values from schema
- to_ffi_config converts all types correctly
  </action>
  <verify>cargo test --lib config && cargo clippy -- -D warnings</verify>
  <done>PluginConfigLoader can load TOML, validate against schema, and convert to FFI types</done>
</task>

</tasks>

<verification>
After all tasks:
1. `cargo build -p totui-plugin-interface` - Interface crate compiles
2. `cargo build` - Host application compiles
3. `cargo test --lib` - All tests pass
4. `cargo clippy -- -D warnings` - No warnings
</verification>

<success_criteria>
- FfiConfigValue/Type/Field/Schema exist in totui-plugin-interface with StableAbi
- Plugin trait has config_schema() and on_config_loaded() methods
- PluginConfigLoader validates TOML against schema with field-specific errors
- Path helpers return correct XDG config paths
- All tests pass and no clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/11-plugin-configuration/11-01-SUMMARY.md`
</output>
